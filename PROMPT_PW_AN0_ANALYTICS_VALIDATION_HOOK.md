# Frontier Model Handoff: pw-an0 Pre-Commit Hook for Analytics Validation

## Task Overview
Create a **pre-commit/pre-push hook** that validates all interactive components have proper analytics `data-event` attributes. This ensures developers can't accidentally commit untracked interactions.

**Issue**: pw-an0  
**Priority**: P1  
**Type**: Task  
**Output Locations**:
- Hook script: `.husky/pre-push` (already exists, needs modification)
- Validation script: `.github/scripts/validate-analytics.sh` (new)
- Related: `scripts/build-path.sh` (may integrate with existing path-based build)

## Context & Prior Work

### Completed Foundation (pw-v01)
Created comprehensive Feature Development Checklist that makes analytics mandatory. This hook enforces it.
- File: `docs/development/FEATURE_DEVELOPMENT_CHECKLIST.md`
- Mandates `data-event` attributes on interactive elements
- Requires tests before implementation

### Analytics Pattern Established
From pw-26 (Analytics Tracking) and pw-27 (Cookie Consent):

**Interactive components that REQUIRE tracking:**
1. **Buttons with tracking**:
   ```html
   {{ partial "components/button.html" (dict
     "trackingEvent" "event_name"
     "trackingLabel" "label"
   ) }}
   ```
   - Generated with `data-event` and `data-event-label` attributes
   - Auto-wired onclick handler

2. **Explicit data-event attributes**:
   ```html
   <button data-event="button_click" data-event-label="Sign Up">Sign Up</button>
   <a href="..." data-event="external_link_click">External</a>
   <form data-event="form_submit">...</form>
   ```

3. **Allowed exceptions** (no tracking needed):
   - Navigation links (already tracked by section view)
   - Links to internal pages (same domain)
   - Decorative elements (no role="button", not interactive)
   - Hidden elements (display:none, visibility:hidden)

### Current State
- Pre-push hook exists: `.husky/pre-push`
- Runs: `bun run build:path` (path-based build system)
- This hook runs on `git push`, validates before reaching remote
- CI runs full test suite afterward

### File References
- Button component: `layouts/partials/components/button.html`
- Analytics module: `static/js/analytics.js`
- Existing hook: `.husky/pre-push`
- Build script: `scripts/build-path.sh`

## Requirements

### 1. What to Validate
The hook should check modified files for interactive elements:

**Find interactive elements:**
- `<button>` tags (all)
- `<a href="...">` tags (external links only)
- `[role="button"]` elements
- `<input type="submit">` tags
- Elements with `onclick` attribute

**Validate they have:**
- `data-event="event_name"` attribute (snake_case)
- `data-event-label="label_text"` attribute (human-readable)
- OR: Generated by `button.html` component (recognized pattern)
- OR: Listed in exceptions (internal links, decorative elements)

**Allow these exceptions:**
- Links without `href` attribute
- Links with `href="#"` (anchor links)
- Links with `href="/..."` (internal site navigation)
- Links with `rel="noopener noreferrer"` (external but explicitly not tracked)
- Disabled elements: `disabled="disabled"` or `[aria-disabled="true"]`
- Hidden elements: `display:none`, `visibility:hidden`, `hidden` attribute
- Elements with `data-no-track` attribute (explicit opt-out)

### 2. Hook Implementation Options

**Option A: Bash script (recommended)**
- Use `grep` + `ripgrep` to find interactive elements
- Check for `data-event` attributes
- Report violations with file:line format
- Fast, no external dependencies

**Option B: Node.js script (if Bash too complex)**
- Parse HTML/templates with cheerio or similar
- More accurate HTML parsing
- Slower, requires npm install

**Recommendation**: Bash + ripgrep for speed. Hook should complete in <2 seconds.

### 3. Output Format
When violations found, report as:
```
‚ùå Analytics Validation Failed

üìç Missing data-event attributes:
  layouts/partials/sections/hero.html:42
    <button class="btn">Download</button>
    
  layouts/partials/components/cta.html:15
    <a href="https://external.com">Click here</a>

üìã Allowed exceptions:
  - Internal navigation links (href="/...")
  - Disabled elements (disabled attribute)
  - Hidden elements (display:none)
  - Explicit opt-out: data-no-track

‚ÑπÔ∏è  See: docs/development/FEATURE_DEVELOPMENT_CHECKLIST.md
```

### 4. Integration Points

**Pre-push hook** (`.husky/pre-push`):
- Currently runs: `bun run build:path`
- Should add: call to analytics validation before/after build
- Decision: Run before build (fail fast) or after tests (more complete)?
- **Recommendation**: Run after tests pass (more value)

**Build script** (`scripts/build-path.sh`):
- May already call validation scripts
- Check what it does currently
- Integrate validation into path-based build if appropriate

**GitHub Actions** (`.github/workflows/`):
- CI already runs full test suite
- Optional: Add validation step for visibility

### 5. Performance Constraints
- Hook runs on every `git push`
- Must complete in <5 seconds (ideally <2)
- Use ripgrep for fast file scanning
- Cache results if possible
- Don't rebuild site, just validate

### 6. Bypass Mechanism
For legitimate exceptions:
```bash
# Skip analytics validation hook only
git push --no-verify

# OR mark specific elements
<button data-no-track>Internal Admin Button</button>
```

Document this in hook output: "Use `git push --no-verify` to skip (not recommended)"

## Success Criteria

The validation hook should:
1. ‚úÖ Detect all interactive HTML elements
2. ‚úÖ Verify `data-event` and `data-event-label` attributes exist
3. ‚úÖ Recognize `button.html` component (no double-checking)
4. ‚úÖ Report violations with file:line numbers
5. ‚úÖ Execute in <2 seconds on typical 20-file change
6. ‚úÖ Prevent push if violations found
7. ‚úÖ Document exceptions clearly
8. ‚úÖ Provide help text (which attributes, where to learn more)

## Files to Create/Modify

### Create: `.github/scripts/validate-analytics.sh`
```bash
#!/bin/bash
# Validates all modified files have proper analytics tracking

# Accepts one argument:
# - If "all": validate entire project
# - If empty: validate only git staged/modified files

# Exits with:
# - 0: All checks passed
# - 1: Violations found
```

**High-level algorithm:**
1. Get list of modified HTML/template files
2. Find all interactive elements in those files
3. For each element:
   - Check if it has `data-event` attribute
   - Check if generated by `button.html` (safe)
   - Check if in exceptions list (internal link, disabled, etc.)
4. Collect violations
5. Report with file:line format
6. Exit with proper code

### Modify: `.husky/pre-push`
- Add call to analytics validation
- Decide: Before or after `bun run build:path`?
- **Recommendation**: After (more complete validation)
- Only block if violations found

### Document: Add section to `FEATURE_DEVELOPMENT_CHECKLIST.md`
- Show what the hook validates
- List exceptions
- Show how to use `data-no-track` for opt-out
- Show `--no-verify` bypass (with warning)

## Example Violations the Hook Should Catch

```html
<!-- ‚ùå FAIL: No data-event attribute -->
<button class="btn btn-primary">Download</button>

<!-- ‚ùå FAIL: data-event but missing label -->
<button data-event="download">Download</button>

<!-- ‚ùå FAIL: External link, no tracking -->
<a href="https://example.com">Visit Site</a>

<!-- ‚úÖ PASS: Has both attributes -->
<button data-event="button_click" data-event-label="Download">Download</button>

<!-- ‚úÖ PASS: Generated by button component -->
{{ partial "components/button.html" (dict "trackingEvent" "download") }}

<!-- ‚úÖ PASS: Internal navigation, exception -->
<a href="/blog/">Read Blog</a>

<!-- ‚úÖ PASS: Disabled, exception -->
<button disabled>Not Available</button>

<!-- ‚úÖ PASS: Marked no-track -->
<button data-no-track>Admin Only</button>
```

## Testing the Hook

Hook should be tested by:
1. Creating a test file with violations
2. Running `git add <file>`
3. Running `git push` (should fail)
4. Fix violations, push again (should succeed)

**Or**: Run validation script directly:
```bash
# Test on modified files
.github/scripts/validate-analytics.sh

# Test entire project
.github/scripts/validate-analytics.sh all
```

## Do NOT
- Break existing pre-push hook functionality
- Require new npm dependencies
- Add significant performance overhead (>5 sec)
- Check HTML in test files (only layouts, content, components)
- Prevent legitimate non-interactive elements from being added
- Require analytics on every element (only interactive ones)

## Do
- Use ripgrep for fast scanning
- Include clear error messages with file:line locations
- Document exceptions clearly
- Make it easy to opt-out when needed (data-no-track)
- Integrate with existing build:path system
- Test on actual feature branches with real violations

## Related Issues
- **pw-v01**: Feature Development Checklist (now complete)
- **pw-aog**: Analytics patterns documentation (P2, next after this)
- **pw-g5f**: Beads 0.24 integration (P1, separate track)

## Deliverables
1. **Script**: `.github/scripts/validate-analytics.sh`
2. **Integration**: Update `.husky/pre-push` to call validation
3. **Documentation**: Add hook section to `FEATURE_DEVELOPMENT_CHECKLIST.md`
4. **Test**: Verify hook catches violations and allows valid code

## Notes
- Hook should be non-blocking for team productivity (clear error + bypass available)
- Focus on preventing common mistakes, not perfect validation
- False positives are okay (developers can use data-no-track)
- False negatives are bad (must catch real violations)
- Keep the validation rule simple: "Interactive elements must have data-event"

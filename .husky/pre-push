#!/bin/bash

# Enhanced pre-push hook with safety checks and flexible confirmation
# This prevents accidental pushes without proper review
#
# NOTE: This script contains ANSI escape sequences and references to FORCE_PUSH
# environment variable. These are intentional development safety guardrails and
# are explicitly allowlisted in .gitleaksignore. They are NOT secrets.
# See .gitleaksignore for more details.

set -e

# Colors for better readability
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîí PRE-PUSH GUARDRAIL ACTIVATED${NC}"
echo -e "${BLUE}=================================${NC}"
echo ""

# Check if this is a force push
if [[ "$@" == *"--force"* ]] || [[ "$@" == *"-f"* ]]; then
    echo -e "${RED}‚ö†Ô∏è  FORCE PUSH DETECTED!${NC}"
    echo -e "${RED}This will overwrite remote history. Are you absolutely sure?${NC}"
    echo ""
fi

# Show commits being pushed
echo -e "${YELLOW}Commits to be pushed:${NC}"
echo ""
git log --oneline --graph --decorate --color origin/main..HEAD 2>/dev/null | head -10 || git log --oneline --graph --decorate --color -5

echo ""
echo -e "${YELLOW}Files changed in this push:${NC}"
echo ""
git diff --stat origin/main..HEAD 2>/dev/null || git diff --stat HEAD~5..HEAD 2>/dev/null || echo "Unable to show file changes"

echo ""
echo -e "${YELLOW}Build status check:${NC}"
if hugo --quiet 2>/dev/null; then
    echo -e "${GREEN}‚úÖ Build test passed${NC}"
else
    echo -e "${RED}‚ùå Build test failed${NC}"
    echo -e "${RED}Please fix build issues before pushing${NC}"
    exit 1
fi

echo ""
echo -e "${RED}‚ö†Ô∏è  PUSH GUARDRAIL: This will deploy changes to production!${NC}"
echo ""
echo -e "${YELLOW}Please confirm you want to proceed:${NC}"
echo "  ‚Ä¢ Have you tested the build locally? ${GREEN}‚úÖ${NC}"
echo "  ‚Ä¢ Have you reviewed all changes above? ${GREEN}‚Üê${NC}"
echo "  ‚Ä¢ Are you ready to deploy to production? ${GREEN}?${NC}"
echo ""

# Handle different environments
if [ -t 0 ] && [ "$FORCE_PUSH" != "yes" ]; then
    # Interactive terminal - ask for confirmation
    printf -e "${BLUE}Type 'yes' to confirm and push, or anything else to cancel: ${NC}"
    read -r confirm
    
    if [ "$confirm" != "yes" ]; then
        echo ""
        echo -e "${RED}‚ùå Push cancelled. Changes not deployed.${NC}"
        echo -e "${YELLOW}üí° Run 'git push' again when ready, or use 'FORCE_PUSH=yes git push' for automation.${NC}"
        exit 1
    fi
elif [ "$FORCE_PUSH" = "yes" ]; then
    echo -e "${YELLOW}üöÄ Force push enabled via environment variable${NC}"
    echo -e "${YELLOW}Skipping interactive confirmation${NC}"
else
    echo -e "${RED}‚ùå Cannot read input in this environment${NC}"
    echo -e "${YELLOW}üí° Use 'FORCE_PUSH=yes git push' for automation${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ Push confirmed. Proceeding with deployment...${NC}"

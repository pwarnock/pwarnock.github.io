#!/bin/bash

# Pre-Commit Hook: Auto-Version & Quality Gates
# 
# This hook:
# 1. Auto-increments version based on semantic versioning signals
# 2. Runs linting and validation
# 3. Prevents commit if quality gates fail

set -e

echo ""
echo "üîç Running pre-commit checks..."
echo ""

# ============================================================================
# STEP 1: Auto-version the commit
# ============================================================================

echo "üì¶ Checking version..."
node scripts/auto-version.js

# Stage the version update if hugo.toml changed
if git diff hugo.toml --quiet; then
  :  # No changes
else
  echo "üìù Staging version update..."
  git add hugo.toml
fi

# ============================================================================
# STEP 2: Run linting (source CSS only, not generated)
# ============================================================================

echo ""
echo "üé® Linting CSS..."
if ! bun run lint 2>/dev/null; then
  echo "‚ùå CSS linting failed"
  exit 1
fi

echo "‚úÖ Linting passed"

# ============================================================================
# STEP 3: Validation
# ============================================================================

echo ""
echo "‚úîÔ∏è  Validating files..."
if ! bun run validate 2>/dev/null; then
  echo "‚ùå Validation failed"
  exit 1
fi

echo "‚úÖ Validation passed"

# ============================================================================
# STEP 4: Test build (quick smoke test)
# ============================================================================

echo ""
echo "üî® Testing build..."
if ! hugo --quiet 2>/dev/null; then
  echo "‚ùå Build failed"
  exit 1
fi

echo "‚úÖ Build test passed"

# ============================================================================
# SUMMARY
# ============================================================================

echo ""
echo "‚úÖ All pre-commit checks passed!"
echo ""
